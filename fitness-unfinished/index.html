i<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack - Mobile Fitness Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #4a6fa5;
            --secondary: #166088;
            --accent: #49dcb1;
            --light: #f8f9fa;
            --dark: #343a40;
            --danger: #e76f51;
            --success: #2a9d8f;
            --warning: #e9c46a;
        }
        
        body {
            background-color: #f5f7fb;
            color: var(--dark);
            max-width: 500px;
            margin: 0 auto;
            padding-bottom: 80px;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            min-height: 100vh;
            position: relative;
        }
        
        /* Login/Register Screens */
        .auth-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
            color: white;
        }
        
        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            color: var(--dark);
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .auth-logo i {
            color: var(--accent);
        }
        
        .auth-subtitle {
            color: #666;
            font-size: 0.9rem;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .auth-input-group {
            position: relative;
        }
        
        .auth-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .auth-input-group input, 
        .auth-input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        .auth-input-group input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .auth-btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .auth-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .auth-switch {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .auth-switch a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        .auth-switch a:hover {
            text-decoration: underline;
        }
        
        /* Profile Section */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
        }
        
        .profile-avatar {
            width: 60px;
            height: 60px;
            background-color: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .profile-info h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }
        
        .profile-info p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 15px;
            background-color: white;
            border-bottom: 1px solid #eee;
        }
        
        .profile-stat {
            text-align: center;
        }
        
        .profile-stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .profile-stat-label {
            font-size: 0.8rem;
            color: #666;
        }
        
        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .logo i {
            color: var(--accent);
        }
        
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .date-display {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .nav-tabs {
            display: flex;
            background-color: white;
            border-bottom: 1px solid #eaeaea;
            position: sticky;
            top: 86px;
            z-index: 99;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 15px 5px;
            color: var(--dark);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--accent);
        }
        
        .tab i {
            display: block;
            margin-bottom: 5px;
            font-size: 1.2rem;
        }
        
        .tab-content {
            display: none;
            padding: 20px 15px;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary);
        }
        
        .progress-container {
            margin: 15px 0;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--accent), var(--success));
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        
        .calories-display {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-top: 20px;
        }
        
        .calorie-item {
            flex: 1;
        }
        
        .calorie-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .calorie-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }
        
        .water-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        
        .water-glass {
            width: 50px;
            height: 70px;
            background-color: #e3f2fd;
            border-radius: 0 0 10px 10px;
            position: relative;
            border: 2px solid #bbdefb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .water-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background-color: #4fc3f7;
            border-radius: 0 0 8px 8px;
            transition: height 0.3s;
        }
        
        .log-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input, select {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 12px 20px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-add {
            background: linear-gradient(to right, var(--success), #1b998b);
        }
        
        .btn-danger {
            background: linear-gradient(to right, var(--danger), #d65c40);
        }
        
        .log-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background-color: #fafafa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .log-item:last-child {
            border-bottom: none;
        }
        
        .log-info {
            flex: 1;
        }
        
        .log-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .log-details {
            font-size: 0.9rem;
            color: #666;
            display: flex;
            gap: 15px;
        }
        
        .log-calories {
            color: var(--danger);
            font-weight: 600;
        }
        
        .log-actions {
            display: flex;
            gap: 10px;
        }
        
        .icon-btn {
            background: none;
            border: none;
            color: #999;
            font-size: 1.1rem;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .icon-btn:hover {
            color: var(--primary);
        }
        
        .delete-btn:hover {
            color: var(--danger);
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid var(--accent);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 500px;
            background: white;
            padding: 15px;
            text-align: center;
            border-top: 1px solid #eaeaea;
            z-index: 100;
        }
        
        .quick-add {
            display: flex;
            justify-content: space-around;
        }
        
        .quick-btn {
            background: white;
            border: 1px solid #eaeaea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }
        
        .quick-btn:hover {
            transform: translateY(-5px);
            background-color: var(--primary);
            color: white;
        }

        /* Dashboard quick actions (inside dashboard card) */
        .dashboard-quick {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
        }

        .dashboard-quick-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            color: #555;
        }

        .dashboard-quick-btn i {
            font-size: 1.1rem;
            margin-bottom: 4px;
            color: var(--primary);
        }

        .dashboard-quick-btn:hover {
            background: white;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
            transform: translateY(-2px);
            border-color: var(--primary);
        }
        
        .profile-tab {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .profile-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .profile-section h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .profile-field {
            margin-bottom: 15px;
        }
        
        .profile-field label {
            display: block;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }
        
        .profile-field span {
            display: block;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            color: #333;
        }
        
        .edit-profile-btn {
            width: 100%;
            margin-top: 10px;
        }
        
        /* NUTRI SCAN AI STYLES - ADDED */
        .nutri-scan-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }
        
        .nutri-scan-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .nutri-scan-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary);
        }
        
        .ai-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .scan-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .scan-option-btn {
            background: #f8f9fa;
            border: 2px solid #eaeaea;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .scan-option-btn:hover {
            border-color: var(--primary);
            background: #f0f7ff;
            transform: translateY(-2px);
        }
        
        .scan-option-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .scan-option-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--dark);
        }
        
        .scan-option-desc {
            font-size: 0.75rem;
            color: #666;
            margin-top: 3px;
        }
        
        .scan-preview {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 12px;
            height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .scan-preview:hover {
            border-color: var(--primary);
            background: #f0f7ff;
        }
        
        .scan-preview i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .scan-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scan-results {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: none;
        }
        
        .scan-results.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        .scanned-food-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .scan-confidence {
            display: inline-block;
            background: #e8f5e9;
            color: var(--success);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .nutrition-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .nutrition-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .nutrition-label {
            font-size: 0.75rem;
            color: #666;
            margin-top: 3px;
        }
        
        .scan-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .scan-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }
        
        .scan-loading.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .food-suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .food-suggestion {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #eee;
        }
        
        .food-suggestion:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-3px);
        }
        
        .suggestion-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .food-suggestion:hover .suggestion-icon {
            color: white;
        }
        
        .suggestion-name {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .suggestion-calories {
            font-size: 0.7rem;
            color: #666;
            margin-top: 3px;
        }
        
        .food-suggestion:hover .suggestion-calories {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .camera-modal.active {
            display: flex;
        }
        
        .camera-container {
            width: 90%;
            max-width: 400px;
            background: black;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .camera-video {
            width: 100%;
            height: 400px;
            object-fit: cover;
        }
        
        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: #222;
        }
        
        .camera-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #333;
        }
        
        .close-camera {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .ai-scanned-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        @media (max-width: 500px) {
            body {
                box-shadow: none;
            }
            
            .tab {
                font-size: 0.75rem;
                padding: 12px 2px;
            }
            
            .tab i {
                font-size: 1rem;
            }
            
            .card {
                padding: 15px;
            }
            
            .auth-container {
                padding: 20px;
            }
            
            .scan-options {
                grid-template-columns: 1fr;
            }
            
            .food-suggestions {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="auth-screen">
        <div class="auth-container">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-heartbeat"></i>
                    <span>FitTrack</span>
                </div>
                <p class="auth-subtitle">Log in to your fitness account</p>
            </div>
            
            <form class="auth-form" id="loginForm">
                <div class="auth-input-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" required>
                </div>
                
                <div class="auth-input-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                
                <button type="submit" class="auth-btn">
                    <i class="fas fa-sign-in-alt"></i> Log In
                </button>
                
                <div class="auth-switch">
                    <p>Don't have an account? <a id="showRegister">Register here</a></p>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Register Screen -->
    <div id="registerScreen" class="auth-screen" style="display: none;">
        <div class="auth-container">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-heartbeat"></i>
                    <span>FitTrack</span>
                </div>
                <p class="auth-subtitle">Create your fitness account</p>
            </div>
            
            <form class="auth-form" id="registerForm">
                <div class="auth-input-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" placeholder="John Doe" required>
                </div>
                
                <div class="auth-input-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com" required>
                </div>
                
                <div class="auth-input-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" placeholder="Create a password" required>
                </div>
                
                <div class="auth-input-group">
                    <label for="registerAge">Age</label>
                    <input type="number" id="registerAge" placeholder="25" min="10" max="100" required>
                </div>
                
                <div class="auth-input-group">
                    <label for="registerGender">Gender</label>
                    <select id="registerGender" required>
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="auth-input-group">
                    <label for="registerHeight">Height (cm)</label>
                    <input type="number" id="registerHeight" placeholder="175" min="100" max="250" required>
                </div>
                
                <div class="auth-input-group">
                    <label for="registerWeight">Weight (kg)</label>
                    <input type="number" id="registerWeight" placeholder="70" min="30" max="300" required>
                </div>
                
                <div class="auth-input-group">
                    <label for="registerGoal">Fitness Goal</label>
                    <select id="registerGoal" required>
                        <option value="">Select Goal</option>
                        <option value="weight_loss">Weight Loss</option>
                        <option value="muscle_gain">Muscle Gain</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="endurance">Endurance</option>
                    </select>
                </div>
                
                <div class="auth-input-group">
                    <label for="registerActivity">Activity Level</label>
                    <select id="registerActivity" required>
                        <option value="">Select Activity Level</option>
                        <option value="sedentary">Sedentary (little or no exercise)</option>
                        <option value="light">Light (exercise 1-3 days/week)</option>
                        <option value="moderate">Moderate (exercise 3-5 days/week)</option>
                        <option value="active">Active (exercise 6-7 days/week)</option>
                        <option value="very_active">Very Active (hard exercise daily)</option>
                    </select>
                </div>
                
                <button type="submit" class="auth-btn">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
                
                <div class="auth-switch">
                    <p>Already have an account? <a id="showLogin">Log in here</a></p>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Main App (hidden until logged in) -->
    <div id="mainApp" style="display: none;">
        <header>
            <div class="logo">
                <i class="fas fa-heartbeat"></i>
                <span>FitTrack</span>
            </div>
            <div class="header-actions">
                <div class="date-display" id="currentDate">Monday, September 16, 2023</div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>
        
        <div class="profile-section" id="profileHeader">
            <!-- Profile header will be dynamically added here -->
        </div>
        
        <div class="nav-tabs">
            <div class="tab active" data-tab="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </div>
            <div class="tab" data-tab="food">
                <i class="fas fa-utensils"></i>
                <span>Food</span>
            </div>
            <div class="tab" data-tab="exercise">
                <i class="fas fa-running"></i>
                <span>Exercise</span>
            </div>
            <div class="tab" data-tab="water">
                <i class="fas fa-tint"></i>
                <span>Water</span>
            </div>
            <div class="tab" data-tab="profile">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Today's Calories</h2>
                    <span class="calorie-total">1,850 / 2,000</span>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Calories Consumed</span>
                        <span id="calories-consumed-percent">92%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="calories-consumed-bar" style="width: 92%;"></div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Calories Burned</span>
                        <span id="calories-burned-percent">16%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="calories-burned-bar" style="width: 16%;"></div>
                    </div>
                </div>
                <div class="calories-display">
                    <div class="calorie-item">
                        <div class="calorie-value" id="calories-consumed">1,850</div>
                        <div class="calorie-label">Consumed</div>
                    </div>
                    <div class="calorie-item">
                        <div class="calorie-value" id="calories-burned">320</div>
                        <div class="calorie-label">Burned</div>
                    </div>
                    <div class="calorie-item">
                        <div class="calorie-value" id="calories-remaining">150</div>
                        <div class="calorie-label">Remaining</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Water Intake</h2>
                    <span id="water-total">6.5 / 8 glasses</span>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Daily Hydration</span>
                        <span id="water-progress-percent">81%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="water-progress-bar" style="width: 81%;"></div>
                    </div>
                </div>
                <div class="water-container" id="dashboard-water">
                    <!-- Water glasses will be dynamically generated here -->
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent Activities</h2>
                </div>
                <div class="log-list" id="recent-activities">
                    <!-- Recent activities will be dynamically added here -->
                </div>
            </div>
        </div>
        
        <!-- Food Log Tab - WITH ADDED NUTRI SCAN AI -->
        <div id="food" class="tab-content">
            <!-- Nutri Scan AI Section - ADDED -->
            <div class="nutri-scan-section">
                <div class="nutri-scan-header">
                    <h2 class="nutri-scan-title">Nutri Scan AI</h2>
                    <span class="ai-badge">
                        <i class="fas fa-robot"></i> AI-Powered
                    </span>
                </div>
                
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">
                    Scan your food using AI to automatically detect and log nutrition information.
                </p>
                
                <div class="scan-options">
                    <div class="scan-option-btn" id="takePhotoBtn">
                        <i class="fas fa-camera scan-option-icon"></i>
                        <span class="scan-option-label">Take Photo</span>
                        <span class="scan-option-desc">Use camera</span>
                    </div>
                    
                    <div class="scan-option-btn" id="uploadPhotoBtn">
                        <i class="fas fa-upload scan-option-icon"></i>
                        <span class="scan-option-label">Upload Photo</span>
                        <span class="scan-option-desc">From gallery</span>
                    </div>
                </div>
                
                <div class="scan-preview" id="scanPreview">
                    <div class="scan-loading" id="scanLoading">
                        <div class="loading-spinner"></div>
                        <p>Analyzing your food...</p>
                    </div>
                    
                    <i class="fas fa-camera"></i>
                    <p>Tap to scan your food</p>
                    <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">or select an option above</p>
                </div>
                
                <!-- Food Suggestions -->
                <div class="food-suggestions" id="foodSuggestions">
                    <!-- Food suggestions will be added by JavaScript -->
                </div>
                
                <!-- Scan Results -->
                <div class="scan-results" id="scanResults">
                    <div class="scanned-food-name" id="scannedFoodName">Grilled Chicken Breast</div>
                    <div class="scan-confidence" id="scanConfidence">94% confidence</div>
                    
                    <div class="nutrition-grid">
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="scanCalories">165</div>
                            <div class="nutrition-label">Calories</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="scanProtein">31g</div>
                            <div class="nutrition-label">Protein</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="scanCarbs">0g</div>
                            <div class="nutrition-label">Carbs</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="scanFat">3.6g</div>
                            <div class="nutrition-label">Fat</div>
                        </div>
                    </div>
                    
                    <div class="scan-actions">
                        <button class="btn btn-add" id="addScannedFood">
                            <i class="fas fa-plus"></i> Add to Food Log
                        </button>
                        <button class="btn" id="rescanFood">
                            <i class="fas fa-redo"></i> Scan Again
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Original Food Log Card - UNCHANGED -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Log Food</h2>
                </div>
                <form class="log-form" id="food-form">
                    <div class="form-group">
                        <label for="food-name">Food Name</label>
                        <input type="text" id="food-name" placeholder="e.g., Grilled Chicken" required>
                    </div>
                    <div class="form-group">
                        <label for="food-calories">Calories</label>
                        <input type="number" id="food-calories" placeholder="e.g., 250" required>
                    </div>
                    <div class="form-group">
                        <label for="food-meal">Meal Type</label>
                        <select id="food-meal">
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="snack">Snack</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-add">
                        <i class="fas fa-plus"></i> Add Food
                    </button>
                </form>
            </div>
            
            <!-- Original Food Log Card - UNCHANGED -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Today's Food Log</h2>
                </div>
                <div class="log-list" id="food-log">
                    <!-- Food items will be dynamically added here -->
                </div>
                <div class="empty-state" id="empty-food">
                    <i class="fas fa-utensils"></i>
                    <p>No food logged today. Add your first meal!</p>
                </div>
            </div>
        </div>
        
        <!-- Exercise Log Tab -->
        <div id="exercise" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Log Exercise</h2>
                </div>
                <form class="log-form" id="exercise-form">
                    <div class="form-group">
                        <label for="exercise-name">Exercise</label>
                        <input type="text" id="exercise-name" placeholder="e.g., Running" required>
                    </div>
                    <div class="form-group">
                        <label for="exercise-duration">Duration (minutes)</label>
                        <input type="number" id="exercise-duration" placeholder="e.g., 30" required>
                    </div>
                    <div class="form-group">
                        <label for="exercise-calories">Calories Burned</label>
                        <input type="number" id="exercise-calories" placeholder="e.g., 250" required>
                    </div>
                    <button type="submit" class="btn btn-add">
                        <i class="fas fa-plus"></i> Add Exercise
                    </button>
                </form>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Today's Exercises</h2>
                </div>
                <div class="log-list" id="exercise-log">
                    <!-- Exercise items will be dynamically added here -->
                </div>
                <div class="empty-state" id="empty-exercise">
                    <i class="fas fa-running"></i>
                    <p>No exercises logged today. Add your first activity!</p>
                </div>
            </div>
        </div>
        
        <!-- Water Log Tab -->
        <div id="water" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Water Intake Tracker</h2>
                </div>
                <p style="margin-bottom: 15px; color: #666;">Goal: <span id="water-goal">8</span> glasses (<span id="water-liters">2</span> liters) per day</p>
                <div class="water-container" id="water-tracker">
                    <!-- Water glasses will be dynamically generated here -->
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn" id="add-water">
                        <i class="fas fa-tint"></i> Add 1 Glass (250ml)
                    </button>
                    <button class="btn btn-danger" id="reset-water" style="margin-top: 10px;">
                        <i class="fas fa-redo"></i> Reset Water
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Today's Water Log</h2>
                </div>
                <div class="log-list" id="water-log">
                    <!-- Water intake logs will be dynamically added here -->
                </div>
            </div>
        </div>
        
        <!-- Profile Tab -->
        <div id="profile" class="tab-content">
            <div class="profile-tab">
                <div class="profile-section">
                    <h3>Personal Information</h3>
                    <div class="profile-field">
                        <label>Full Name</label>
                        <span id="profile-name">John Doe</span>
                    </div>
                    <div class="profile-field">
                        <label>Email</label>
                        <span id="profile-email">john.doe@example.com</span>
                    </div>
                    <div class="profile-field">
                        <label>Age</label>
                        <span id="profile-age">25</span>
                    </div>
                    <div class="profile-field">
                        <label>Gender</label>
                        <span id="profile-gender">Male</span>
                    </div>
                    <button class="btn edit-profile-btn" id="editPersonalBtn">
                        <i class="fas fa-edit"></i> Edit Personal Info
                    </button>
                </div>
                
                <div class="profile-section">
                    <h3>Fitness Profile</h3>
                    <div class="profile-field">
                        <label>Height</label>
                        <span id="profile-height">175 cm</span>
                    </div>
                    <div class="profile-field">
                        <label>Weight</label>
                        <span id="profile-weight">70 kg</span>
                    </div>
                    <div class="profile-field">
                        <label>BMI</label>
                        <span id="profile-bmi">22.9</span>
                    </div>
                    <div class="profile-field">
                        <label>Fitness Goal</label>
                        <span id="profile-goal">Weight Loss</span>
                    </div>
                    <div class="profile-field">
                        <label>Activity Level</label>
                        <span id="profile-activity">Moderate</span>
                    </div>
                    <div class="profile-field">
                        <label>Daily Calorie Target</label>
                        <span id="profile-calories">2,000</span>
                    </div>
                    <button class="btn edit-profile-btn" id="editFitnessBtn">
                        <i class="fas fa-edit"></i> Edit Fitness Profile
                    </button>
                </div>
                
                <div class="profile-section">
                    <h3>Account Settings</h3>
                    <button class="btn" style="margin-bottom: 10px;" id="changePasswordBtn">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                    <button class="btn btn-danger" id="deleteAccountBtn">
                        <i class="fas fa-trash"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>
        
        <footer>
            <div class="quick-add">
                <div class="quick-btn" data-quick="food">
                    <i class="fas fa-utensils"></i>
                </div>
                <div class="quick-btn" data-quick="exercise">
                    <i class="fas fa-running"></i>
                </div>
                <div class="quick-btn" data-quick="water">
                    <i class="fas fa-tint"></i>
                </div>
            </div>
        </footer>
        
        <!-- Camera Modal - ADDED FOR NUTRI SCAN -->
        <div class="camera-modal" id="cameraModal">
            <div class="camera-container">
                <button class="close-camera" id="closeCamera">
                    <i class="fas fa-times"></i>
                </button>
                <video class="camera-video" id="cameraVideo" autoplay></video>
                <div class="camera-controls">
                    <button class="camera-btn" id="capturePhoto">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // User management
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('fitTrackUsers')) || [];
        
        // User data storage
        let foodLog = [];
        let exerciseLog = [];
        let waterLog = [];
        
        // Set current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
        
        // Switch between login and register screens
        document.getElementById('showRegister').addEventListener('click', () => {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('registerScreen').style.display = 'flex';
        });
        
        document.getElementById('showLogin').addEventListener('click', () => {
            document.getElementById('registerScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        });
        
        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Find user
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                // Successful login
                currentUser = user;
                loadUserData();
                showMainApp();
            } else {
                alert('Invalid email or password. Please try again.');
            }
        });
        
        // Register form submission
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Check if user already exists
            const email = document.getElementById('registerEmail').value;
            const existingUser = users.find(u => u.email === email);
            
            if (existingUser) {
                alert('An account with this email already exists. Please log in instead.');
                return;
            }
            
            // Calculate BMI
            const height = document.getElementById('registerHeight').value;
            const weight = document.getElementById('registerWeight').value;
            const bmi = (weight / ((height/100) * (height/100))).toFixed(1);
            
            // Calculate daily calorie needs based on Mifflin-St Jeor Equation
            const age = document.getElementById('registerAge').value;
            const gender = document.getElementById('registerGender').value;
            const activity = document.getElementById('registerActivity').value;
            
            let bmr;
            if (gender === 'male') {
                bmr = 10 * weight + 6.25 * height - 5 * age + 5;
            } else {
                bmr = 10 * weight + 6.25 * height - 5 * age - 161;
            }
            
            // Activity multipliers
            const activityMultipliers = {
                sedentary: 1.2,
                light: 1.375,
                moderate: 1.55,
                active: 1.725,
                very_active: 1.9
            };
            
            const dailyCalories = Math.round(bmr * activityMultipliers[activity]);
            
            // Create new user
            const newUser = {
                id: Date.now(),
                name: document.getElementById('registerName').value,
                email: email,
                password: document.getElementById('registerPassword').value,
                age: age,
                gender: gender,
                height: height,
                weight: weight,
                bmi: bmi,
                goal: document.getElementById('registerGoal').value,
                activity: activity,
                dailyCalories: dailyCalories,
                joinDate: new Date().toISOString()
            };
            
            users.push(newUser);
            localStorage.setItem('fitTrackUsers', JSON.stringify(users));
            
            currentUser = newUser;
            initializeUserData();
            showMainApp();
            
            alert('Account created successfully! Welcome to FitTrack.');
        });
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to log out?')) {
                currentUser = null;
                showLoginScreen();
            }
        });
        
        // Show main app after login
        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('registerScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Update profile header
            updateProfileHeader();
            // Update profile tab
            updateProfileTab();
            // Initialize app
            initApp();
        }
        
        // Show login screen
        function showLoginScreen() {
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('registerScreen').style.display = 'none';
            
            // Clear login form
            document.getElementById('loginForm').reset();
        }
        
        // Track streak / recommendation refresh in memory
        let streakDays = 1;
        let lastActiveDate = null;
        let recommendationsRefreshTimer = null;
        
        // Load user data
        function loadUserData() {
            const userData = JSON.parse(localStorage.getItem(`fitTrackData_${currentUser.id}`)) || {
                foodLog: [],
                exerciseLog: [],
                waterLog: [],
                streakDays: 1,
                lastActiveDate: new Date().toISOString().split('T')[0]
            };
            
            foodLog = userData.foodLog || [];
            exerciseLog = userData.exerciseLog || [];
            waterLog = userData.waterLog || [];
            streakDays = userData.streakDays || 1;
            lastActiveDate = userData.lastActiveDate || new Date().toISOString().split('T')[0];
        }
        
        // Initialize user data (for new users)
        function initializeUserData() {
            foodLog = [];
            exerciseLog = [];
            waterLog = [];
            streakDays = 1;
            lastActiveDate = new Date().toISOString().split('T')[0];
            
            saveUserData();
        }
        
        // Save user data
        function saveUserData() {
            const userData = {
                foodLog,
                exerciseLog,
                waterLog,
                streakDays,
                lastActiveDate
            };
            
            localStorage.setItem(`fitTrackData_${currentUser.id}`, JSON.stringify(userData));
        }
        
        // Update profile header
        function updateProfileHeader() {
            const profileHeader = document.getElementById('profileHeader');
            const firstName = currentUser.name.split(' ')[0];
            const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
            

            
            profileHeader.innerHTML = `
                <div class="profile-header">
                    <div class="profile-avatar">${initials}</div>
                    <div class="profile-info">
                        <h3>Hello, ${firstName}!</h3>
                        <p>${currentUser.goal.replace('_', ' ')}  ${currentUser.dailyCalories} daily calories</p>
                    </div>
                </div>
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="profile-stat-value">${streakDays}</div>
                        <div class="profile-stat-label">Day Streak</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value">${currentUser.weight}</div>
                        <div class="profile-stat-label">Current Weight</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value">${currentUser.bmi}</div>
                        <div class="profile-stat-label">BMI</div>
                    </div>
                </div>
            `;
        }
        
        // Update profile tab
        function updateProfileTab() {
            document.getElementById('profile-name').textContent = currentUser.name;
            document.getElementById('profile-email').textContent = currentUser.email;
            document.getElementById('profile-age').textContent = currentUser.age;
            document.getElementById('profile-gender').textContent = currentUser.gender.charAt(0).toUpperCase() + currentUser.gender.slice(1);
            document.getElementById('profile-height').textContent = `${currentUser.height} cm`;
            document.getElementById('profile-weight').textContent = `${currentUser.weight} kg`;
            document.getElementById('profile-bmi').textContent = currentUser.bmi;
            document.getElementById('profile-goal').textContent = currentUser.goal.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            document.getElementById('profile-activity').textContent = currentUser.activity.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            document.getElementById('profile-calories').textContent = currentUser.dailyCalories.toLocaleString();
            
            // Update water goal based on weight
            const waterGoal = Math.max(8, Math.round(currentUser.weight / 10));
            document.getElementById('water-goal').textContent = waterGoal;
            document.getElementById('water-liters').textContent = (waterGoal * 0.25).toFixed(1);
        }
        
        // Tab switching functionality
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show active tab content
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Quick add buttons
        const quickBtns = document.querySelectorAll('.quick-btn');
        quickBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.getAttribute('data-quick');
                
                // Switch to the corresponding tab
                tabs.forEach(t => t.classList.remove('active'));
                document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
                
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(tab).classList.add('active');
            });
        });

        // Dashboard quick buttons (inside Today's Calories card)
        const dashboardQuickBtns = document.querySelectorAll('.dashboard-quick-btn');
        dashboardQuickBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.getAttribute('data-quick-tab');
                if (!tab) return;

                // Switch to the corresponding tab
                tabs.forEach(t => t.classList.remove('active'));
                const targetTab = document.querySelector(`.tab[data-tab="${tab}"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                tabContents.forEach(content => content.classList.remove('active'));
                const targetContent = document.getElementById(tab);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            });
        });
        
        // Calculate totals (base implementation  overridden later to also handle hydration & streak)
        function calculateTotals() {
            // Food calories
            const totalFoodCalories = foodLog.reduce((total, item) => total + item.calories, 0);
            
            // Exercise calories
            const totalExerciseCalories = exerciseLog.reduce((total, item) => total + item.calories, 0);
            
            // Water intake
            const totalWater = waterLog.reduce((total, item) => total + item.amount, 0);
            
            // Update dashboard
            document.getElementById('calories-consumed').textContent = totalFoodCalories;
            document.getElementById('calories-burned').textContent = totalExerciseCalories;
            
            const remaining = currentUser.dailyCalories - totalFoodCalories + totalExerciseCalories;
            document.getElementById('calories-remaining').textContent = Math.max(0, remaining);
            
            // Update progress bar
            const consumedPercentage = Math.min(100, (totalFoodCalories / currentUser.dailyCalories) * 100);
            document.querySelector('#dashboard .progress-fill').style.width = `${consumedPercentage}%`;
            document.querySelector('#dashboard .progress-label span:last-child').textContent = `${Math.round(consumedPercentage)}%`;
            document.querySelector('#dashboard .calorie-total').textContent = `${totalFoodCalories} / ${currentUser.dailyCalories.toLocaleString()}`;
            
            // Update water
            const waterGoal = Math.max(8, Math.round(currentUser.weight / 10));
            document.getElementById('water-total').textContent = `${totalWater} / ${waterGoal} glasses`;
            
            // Update dashboard water glasses
            updateDashboardWater(totalWater, waterGoal);
            
            // Update summary
            document.getElementById('total-calories').textContent = totalFoodCalories;
            document.getElementById('total-burned').textContent = totalExerciseCalories;
            document.getElementById('net-calories').textContent = totalFoodCalories - totalExerciseCalories;
            document.getElementById('total-water').textContent = totalWater;
            
            // Update recent activities
            updateRecentActivities();
            
            // Save user data
            saveUserData();
        }
        
        // Update dashboard water display
        function updateDashboardWater(totalWater, waterGoal) {
            const container = document.getElementById('dashboard-water');
            container.innerHTML = '';
            
            const glassesToShow = Math.min(waterGoal, 8);
            
            for (let i = 0; i < glassesToShow; i++) {
                const glass = document.createElement('div');
                glass.className = 'water-glass';
                glass.style.width = `${350 / glassesToShow}px`;
                
                const fill = document.createElement('div');
                fill.className = 'water-fill';
                
                const glassWater = waterLog[i]?.amount || 0;
                fill.style.height = `${(glassWater / 0.5) * 100}%`;
                
                glass.appendChild(fill);
                container.appendChild(glass);
            }
        }
        
        // Initialize water tracker
        function initWaterTracker() {
            const waterTracker = document.getElementById('water-tracker');
            waterTracker.innerHTML = '';
            
            const waterGoal = Math.max(8, Math.round(currentUser.weight / 10));
            const glassesToShow = Math.min(waterGoal, 12);
            
            for (let i = 0; i < glassesToShow; i++) {
                const glass = document.createElement('div');
                glass.className = 'water-glass';
                glass.style.width = `${Math.min(50, 400 / glassesToShow)}px`;
                glass.setAttribute('data-amount', '0.5');
                glass.setAttribute('data-index', i);
                
                const fill = document.createElement('div');
                fill.className = 'water-fill';
                
                const glassWater = waterLog[i]?.amount || 0;
                fill.style.height = `${(glassWater / 0.5) * 100}%`;
                
                glass.appendChild(fill);
                
                // Add click event to toggle water glass
                glass.addEventListener('click', () => {
                    const index = parseInt(glass.getAttribute('data-index'));
                    toggleWaterGlass(index);
                });
                
                waterTracker.appendChild(glass);
            }
            
            // Update water log list
            updateWaterLog();
        }
        
        // Toggle water glass
        function toggleWaterGlass(index) {
            const currentTime = new Date();
            const timeString = currentTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            
            if (waterLog[index]) {
                // Remove this glass
                waterLog.splice(index, 1);
            } else {
                // Add this glass
                waterLog[index] = { id: Date.now(), amount: 0.5, time: timeString };
            }
            
            initWaterTracker();
            calculateTotals();
        }
        
        // Add water button
        document.getElementById('add-water').addEventListener('click', () => {
            const currentTime = new Date();
            const timeString = currentTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            
            // Find first empty glass
            let added = false;
            const waterGoal = Math.max(8, Math.round(currentUser.weight / 10));
            
            for (let i = 0; i < waterGoal; i++) {
                if (!waterLog[i]) {
                    waterLog[i] = { id: Date.now(), amount: 0.5, time: timeString };
                    added = true;
                    break;
                }
            }
            
            // If all glasses are full, add to the end
            if (!added) {
                waterLog.push({ id: Date.now(), amount: 0.5, time: timeString });
            }
            
            initWaterTracker();
            calculateTotals();
        });
        
        // Reset water button
        document.getElementById('reset-water').addEventListener('click', () => {
            if (confirm("Are you sure you want to reset your water intake for today?")) {
                waterLog = [];
                initWaterTracker();
                calculateTotals();
            }
        });
        
        // Update water log list
        function updateWaterLog() {
            const waterLogContainer = document.getElementById('water-log');
            waterLogContainer.innerHTML = '';
            
            if (waterLog.length === 0) {
                waterLogContainer.innerHTML = '<div class="empty-state"><i class="fas fa-tint"></i><p>No water logged today. Drink up!</p></div>';
                return;
            }
            
            waterLog.forEach((item, index) => {
                if (!item) return;
                
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.innerHTML = `
                    <div class="log-info">
                        <div class="log-name">Glass of Water</div>
                        <div class="log-details">
                            <span>${item.time}</span>
                            <span class="log-calories">+ 250ml</span>
                        </div>
                    </div>
                    <div class="log-actions">
                        <button class="icon-btn delete-btn" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                waterLogContainer.appendChild(logItem);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('#water-log .delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    waterLog.splice(index, 1);
                    initWaterTracker();
                    calculateTotals();
                });
            });
        }
        
        // Update food log display
        function updateFoodLog() {
            const foodLogContainer = document.getElementById('food-log');
            const emptyFood = document.getElementById('empty-food');
            
            if (foodLog.length === 0) {
                emptyFood.style.display = 'block';
                foodLogContainer.innerHTML = '';
                return;
            }
            
            emptyFood.style.display = 'none';
            foodLogContainer.innerHTML = '';
            
            foodLog.forEach(item => {
                let aiBadge = '';
                if (item.scanned) {
                    aiBadge = '<span class="ai-scanned-badge"><i class="fas fa-robot"></i> AI</span>';
                }
                
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.innerHTML = `
                    <div class="log-info">
                        <div class="log-name">
                            ${item.name}
                            ${aiBadge}
                        </div>
                        <div class="log-details">
                            <span>${item.meal.charAt(0).toUpperCase() + item.meal.slice(1)}  ${item.time}</span>
                            <span class="log-calories">+ ${item.calories} cal</span>
                        </div>
                    </div>
                    <div class="log-actions">
                        <button class="icon-btn delete-btn" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                foodLogContainer.appendChild(logItem);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('#food-log .delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    foodLog = foodLog.filter(item => item.id !== id);
                    updateFoodLog();
                    calculateTotals();
                });
            });
        }
        
        // Update exercise log display
        function updateExerciseLog() {
            const exerciseLogContainer = document.getElementById('exercise-log');
            const emptyExercise = document.getElementById('empty-exercise');
            
            if (exerciseLog.length === 0) {
                emptyExercise.style.display = 'block';
                exerciseLogContainer.innerHTML = '';
                return;
            }
            
            emptyExercise.style.display = 'none';
            exerciseLogContainer.innerHTML = '';
            
            exerciseLog.forEach(item => {
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.innerHTML = `
                    <div class="log-info">
                        <div class="log-name">${item.name}</div>
                        <div class="log-details">
                            <span>${item.duration} mins  ${item.time}</span>
                            <span class="log-calories">- ${item.calories} cal</span>
                        </div>
                    </div>
                    <div class="log-actions">
                        <button class="icon-btn delete-btn" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                exerciseLogContainer.appendChild(logItem);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('#exercise-log .delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    exerciseLog = exerciseLog.filter(item => item.id !== id);
                    updateExerciseLog();
                    calculateTotals();
                });
            });
        }
        
        // Update recent activities
        function updateRecentActivities() {
            const recentActivities = document.getElementById('recent-activities');
            recentActivities.innerHTML = '';
            
            // Get today's date string (YYYY-MM-DD)
            const today = new Date().toISOString().split('T')[0];
            
            // Filter to only today's activities and combine
            const allActivities = [
                ...foodLog
                    .filter(item => {
                        // If item has date property, use it; otherwise assume it's today (for backward compatibility)
                        const itemDate = item.date || today;
                        return itemDate === today;
                    })
                    .map(item => ({ ...item, type: 'food' })),
                ...exerciseLog
                    .filter(item => {
                        const itemDate = item.date || today;
                        return itemDate === today;
                    })
                    .map(item => ({ ...item, type: 'exercise' }))
            ];
            
            // Sort by ID (most recent first)
            allActivities.sort((a, b) => b.id - a.id);
            
            // Show only the 3 most recent activities
            const recent = allActivities.slice(0, 3);
            
            if (recent.length === 0) {
                recentActivities.innerHTML = '<div class="empty-state"><i class="fas fa-history"></i><p>No recent activities</p></div>';
                return;
            }
            
            recent.forEach(item => {
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                
                let aiBadge = '';
                if (item.scanned) {
                    aiBadge = '<span class="ai-scanned-badge"><i class="fas fa-robot"></i> AI</span>';
                }
                
                if (item.type === 'food') {
                    logItem.innerHTML = `
                        <div class="log-info">
                            <div class="log-name">
                                ${item.name}
                                ${aiBadge}
                            </div>
                            <div class="log-details">
                                <span>${item.meal.charAt(0).toUpperCase() + item.meal.slice(1)}</span>
                                <span class="log-calories">+ ${item.calories} cal</span>
                            </div>
                        </div>
                        <div class="log-actions">
                            <button class="icon-btn edit-btn"><i class="fas fa-edit"></i></button>
                        </div>
                    `;
                } else {
                    logItem.innerHTML = `
                        <div class="log-info">
                            <div class="log-name">${item.name}</div>
                            <div class="log-details">
                                <span>${item.duration} mins</span>
                                <span class="log-calories">- ${item.calories} cal</span>
                            </div>
                        </div>
                        <div class="log-actions">
                            <button class="icon-btn edit-btn"><i class="fas fa-edit"></i></button>
                        </div>
                    `;
                }
                
                recentActivities.appendChild(logItem);
            });
        }
        
        // Food form submission
        document.getElementById('food-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('food-name').value;
            const calories = parseInt(document.getElementById('food-calories').value);
            const meal = document.getElementById('food-meal').value;
            
            const currentTime = new Date();
            const timeString = currentTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const dateString = currentTime.toISOString().split('T')[0]; // YYYY-MM-DD
            
            const newFood = {
                id: Date.now(),
                name,
                calories,
                meal,
                time: timeString,
                date: dateString, // Add date tracking
                scanned: false
            };
            
            foodLog.push(newFood);
            
            // Reset form
            this.reset();
            
            // Update displays
            updateFoodLog();
            calculateTotals();
            
            // Show success message
            alert(`${name} added to your food log!`);
        });
        
        // Exercise form submission
        document.getElementById('exercise-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('exercise-name').value;
            const duration = parseInt(document.getElementById('exercise-duration').value);
            const calories = parseInt(document.getElementById('exercise-calories').value);
            
            const currentTime = new Date();
            const timeString = currentTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const dateString = currentTime.toISOString().split('T')[0]; // YYYY-MM-DD
            
            const newExercise = {
                id: Date.now(),
                name,
                duration,
                calories,
                time: timeString,
                date: dateString // Add date tracking
            };
            
            exerciseLog.push(newExercise);
            
            // Reset form
            this.reset();
            
            // Update displays
            updateExerciseLog();
            calculateTotals();
            
            // Show success message
            alert(`${name} added to your exercise log!`);
        });
        
        // Profile edit buttons
        document.getElementById('editPersonalBtn').addEventListener('click', () => {
            alert('Personal information editing would be implemented here with a form overlay.');
        });
        
        document.getElementById('editFitnessBtn').addEventListener('click', () => {
            alert('Fitness profile editing would be implemented here with a form overlay.');
        });
        
        document.getElementById('changePasswordBtn').addEventListener('click', () => {
            const newPassword = prompt('Enter your new password:');
            if (newPassword && newPassword.length >= 6) {
                currentUser.password = newPassword;
                // Update in users array
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    localStorage.setItem('fitTrackUsers', JSON.stringify(users));
                }
                alert('Password changed successfully!');
            } else if (newPassword) {
                alert('Password must be at least 6 characters long.');
            }
        });
        
        document.getElementById('deleteAccountBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                // Remove user from users array
                users = users.filter(u => u.id !== currentUser.id);
                localStorage.setItem('fitTrackUsers', JSON.stringify(users));
                
                // Remove user data
                localStorage.removeItem(`fitTrackData_${currentUser.id}`);
                
                // Log out
                currentUser = null;
                showLoginScreen();
                alert('Account deleted successfully.');
            }
        });
        
        // NUTRI SCAN AI FUNCTIONALITY - UPDATED WITH BACKEND INTEGRATION
let scannedFoodData = null;
let cameraStream = null;
let foodDatabase = []; // Will be populated from backend

// Initialize Nutri Scan AI
async function initNutriScanAI() {
    try {
        // Load food database from backend
        await loadFoodDatabase();
        
        // Populate food suggestions
        populateFoodSuggestions();
        
        // Event listeners for scan options
        document.getElementById('takePhotoBtn').addEventListener('click', openCamera);
        document.getElementById('uploadPhotoBtn').addEventListener('click', openFilePicker);
        document.getElementById('scanPreview').addEventListener('click', openFilePicker);
        document.getElementById('closeCamera').addEventListener('click', closeCamera);
        document.getElementById('capturePhoto').addEventListener('click', capturePhoto);
        document.getElementById('addScannedFood').addEventListener('click', addScannedFoodToLog);
        document.getElementById('rescanFood').addEventListener('click', resetScan);
        
        // Setup file upload
        setupFileUpload();
        
        // Add nutrition info toggle
        document.getElementById('toggleNutritionInfo').addEventListener('click', toggleNutritionInfo);
        
        console.log('NutriScan AI initialized successfully');
    } catch (error) {
        console.error('Failed to initialize NutriScan AI:', error);
        showError('Failed to initialize scanning features. Please refresh the page.');
    }
}

// Load food database (frontend-only: use local fallback list)
async function loadFoodDatabase() {
    // Use the built-in fallback database so Nutri Scan works without a backend
    foodDatabase = getFallbackFoodDatabase();
    console.log(`Loaded local food database with ${foodDatabase.length} items.`);
}

// Get appropriate icon based on food category
function getFoodIcon(category) {
    const iconMap = {
        'protein': 'fa-drumstick-bite',
        'dairy': 'fa-cheese',
        'vegetable': 'fa-carrot',
        'fruit': 'fa-apple-alt',
        'grain': 'fa-seedling',
        'meal': 'fa-utensils',
        'snack': 'fa-cookie-bite',
        'supplement': 'fa-pills',
        'soup': 'fa-bowl-food',
        'default': 'fa-utensils'
    };
    
    return iconMap[category] || iconMap.default;
}

// Fallback food database (in case backend fails)
function getFallbackFoodDatabase() {
    return [
        { id: 1, name: "Grilled Chicken Breast", calories: 165, protein: 31, carbs: 0, fat: 3.6, category: "protein", icon: "fa-drumstick-bite" },
        { id: 2, name: "Avocado", calories: 160, protein: 2, carbs: 9, fat: 15, category: "fruit", icon: "fa-leaf" },
        { id: 3, name: "Brown Rice", calories: 112, protein: 2.6, carbs: 23, fat: 0.9, category: "grain", icon: "fa-seedling" },
        { id: 4, name: "Salad Bowl", calories: 120, protein: 5, carbs: 15, fat: 6, category: "meal", icon: "fa-leaf" },
        { id: 5, name: "Protein Shake", calories: 180, protein: 30, carbs: 10, fat: 2, category: "supplement", icon: "fa-blender" },
        { id: 6, name: "Apple", calories: 95, protein: 0.5, carbs: 25, fat: 0.3, category: "fruit", icon: "fa-apple-alt" },
        { id: 7, name: "Eggs (2 whole)", calories: 143, protein: 13, carbs: 1, fat: 10, category: "protein", icon: "fa-egg" },
        { id: 8, name: "Greek Yogurt", calories: 100, protein: 18, carbs: 6, fat: 0.4, category: "dairy", icon: "fa-mortar-pestle" }
    ];
}

// Populate food suggestions
function populateFoodSuggestions() {
    const container = document.getElementById('foodSuggestions');
    
    if (!container) {
        console.error('foodSuggestions container not found');
        return;
    }
    
    container.innerHTML = '';
    
    // Filter suggestions by meal time if available
    const currentHour = new Date().getHours();
    let timeFilteredFoods = foodDatabase;
    
    if (currentHour >= 6 && currentHour < 11) {
        // Morning - show breakfast-friendly foods
        timeFilteredFoods = foodDatabase.filter(food => 
            ['dairy', 'fruit', 'grain'].includes(food.category)
        );
    } else if (currentHour >= 11 && currentHour < 16) {
        // Afternoon - show lunch-friendly foods
        timeFilteredFoods = foodDatabase.filter(food => 
            ['protein', 'meal', 'vegetable'].includes(food.category)
        );
    } else if (currentHour >= 16 && currentHour < 22) {
        // Evening - show dinner-friendly foods
        timeFilteredFoods = foodDatabase.filter(food => 
            !['supplement', 'snack'].includes(food.category)
        );
    } else {
        // Night - show light snacks
        timeFilteredFoods = foodDatabase.filter(food => 
            ['fruit', 'snack', 'supplement'].includes(food.category)
        );
    }
    
    if (timeFilteredFoods.length === 0) {
        timeFilteredFoods = foodDatabase;
    }
    
    // Display suggestions (limit to 8)
    timeFilteredFoods.slice(0, 8).forEach((food, index) => {
        const suggestion = document.createElement('div');
        suggestion.className = 'food-suggestion';
        suggestion.setAttribute('data-id', food.id);
        suggestion.innerHTML = `
            <i class="fas ${food.icon} suggestion-icon"></i>
            <div class="suggestion-name">${food.name}</div>
            <div class="suggestion-calories">${food.calories} cal</div>
            ${food.protein > 15 ? '<span class="protein-badge">High Protein</span>' : ''}
        `;
        
        suggestion.addEventListener('click', () => {
            simulateFoodRecognition(food);
        });
        
        container.appendChild(suggestion);
    });
    
    // Add "View More" option if there are more foods
    if (timeFilteredFoods.length > 8) {
        const viewMore = document.createElement('div');
        viewMore.className = 'food-suggestion view-more';
        viewMore.innerHTML = `
            <i class="fas fa-ellipsis-h suggestion-icon"></i>
            <div class="suggestion-name">View All</div>
        `;
        
        viewMore.addEventListener('click', () => {
            showAllFoodSuggestions();
        });
        
        container.appendChild(viewMore);
    }
}

// Show all food suggestions in a modal
function showAllFoodSuggestions() {
    // Create modal for all suggestions
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>All Food Suggestions</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="food-suggestions-grid" id="allFoodSuggestions">
                    <!-- Food suggestions will be populated here -->
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Populate all suggestions
    const container = document.getElementById('allFoodSuggestions');
    foodDatabase.forEach(food => {
        const suggestion = document.createElement('div');
        suggestion.className = 'food-suggestion large';
        suggestion.innerHTML = `
            <i class="fas ${food.icon} suggestion-icon"></i>
            <div class="suggestion-name">${food.name}</div>
            <div class="suggestion-calories">${food.calories} cal</div>
            <div class="suggestion-macros">
                <span>P: ${food.protein}g</span>
                <span>C: ${food.carbs}g</span>
                <span>F: ${food.fat}g</span>
            </div>
        `;
        
        suggestion.addEventListener('click', () => {
            simulateFoodRecognition(food);
            modal.remove();
        });
        
        container.appendChild(suggestion);
    });
    
    // Close modal handler
    modal.querySelector('.close-modal').addEventListener('click', () => {
        modal.remove();
    });
    
    // Close modal on outside click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Open camera
async function openCamera() {
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            } 
        });
        
        const video = document.getElementById('cameraVideo');
        video.srcObject = cameraStream;
        
        // Play video when metadata is loaded
        video.onloadedmetadata = () => {
            video.play();
        };
        
        document.getElementById('cameraModal').classList.add('active');
        
        // Add camera guidance
        showCameraGuidance();
        
    } catch (err) {
        console.error("Camera error:", err);
        showError("Unable to access camera. Please check permissions or try uploading a photo instead.");
    }
}

// Show camera guidance
function showCameraGuidance() {
    const guidance = document.createElement('div');
    guidance.className = 'camera-guidance';
    guidance.innerHTML = `
        <i class="fas fa-lightbulb"></i>
        <p>Tips for best results:</p>
        <ul>
            <li>Good lighting is important</li>
            <li>Fill frame with the food</li>
            <li>Avoid shadows</li>
            <li>Take from multiple angles</li>
        </ul>
    `;
    
    document.getElementById('cameraModal').appendChild(guidance);
    
    // Remove guidance after 5 seconds
    setTimeout(() => {
        if (guidance.parentNode) {
            guidance.remove();
        }
    }, 5000);
}

// Close camera
function closeCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    document.getElementById('cameraModal').classList.remove('active');
}

// Capture photo
function capturePhoto() {
    const video = document.getElementById('cameraVideo');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    
    // Draw video frame to canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Enhance image for better recognition
    const enhancedCanvas = enhanceImage(canvas);
    
    closeCamera();
    
    // Show captured image
    const preview = document.getElementById('scanPreview');
    preview.innerHTML = '';
    const img = document.createElement('img');
    img.src = enhancedCanvas.toDataURL('image/jpeg', 0.9);
    preview.appendChild(img);
    
    // Add loading state
    preview.classList.add('scanning');
    
    // Send to backend for analysis
    analyzeFoodImage(enhancedCanvas);
}

// Enhance image for better recognition
function enhanceImage(canvas) {
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    
    // Simple contrast enhancement
    for (let i = 0; i < data.length; i += 4) {
        // Increase contrast slightly
        data[i] = Math.min(255, data[i] * 1.1);     // Red
        data[i + 1] = Math.min(255, data[i + 1] * 1.1); // Green
        data[i + 2] = Math.min(255, data[i + 2] * 1.1); // Blue
    }
    
    ctx.putImageData(imageData, 0, 0);
    return canvas;
}

// Replace the analyzeFoodImage function with:

async function analyzeFoodImage(canvas) {
    const loading = document.getElementById('scanLoading');
    const results = document.getElementById('scanResults');
    
    loading.classList.add('active');
    
    try {
        // Frontend-only analysis: simulate AI using the local food database
        const simulatedFood = simulateAIAnalysis(canvas);
        
        // Update UI with results
        updateScanResults(simulatedFood);
        
        // Store analysis data for logging
        scannedFoodData = simulatedFood;
        
        loading.classList.remove('active');
        results.classList.add('active');
        
        // Smooth scroll to results
        setTimeout(() => {
            results.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }, 100);
        
    } catch (error) {
        console.error('Food analysis error:', error);
        loading.classList.remove('active');
        showError('Failed to analyze food image. Please try again.');
        resetScan();
    }
}

// Simulate AI analysis (replace with actual AI integration)
function simulateAIAnalysis(canvas) {
    // Simple simulation - randomly pick a food with some logic
    const now = new Date().getHours();
    let filteredFoods = foodDatabase;
    
    // Filter by time of day
    if (now >= 6 && now < 11) {
        filteredFoods = foodDatabase.filter(food => 
            ['dairy', 'fruit', 'grain'].includes(food.category)
        );
    } else if (now >= 11 && now < 16) {
        filteredFoods = foodDatabase.filter(food => 
            ['protein', 'meal'].includes(food.category)
        );
    }
    
    // Add some randomness but weight towards certain foods
    const randomIndex = Math.floor(Math.random() * filteredFoods.length);
    return filteredFoods[randomIndex] || foodDatabase[0];
}

// Open file picker
function openFilePicker() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment'; // Prefer camera on mobile
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const preview = document.getElementById('scanPreview');
                preview.innerHTML = '';
                preview.classList.add('scanning');
                
                const img = document.createElement('img');
                img.src = event.target.result;
                preview.appendChild(img);
                
                // Convert to canvas for analysis
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const image = new Image();
                
                image.onload = () => {
                    canvas.width = image.width;
                    canvas.height = image.height;
                    ctx.drawImage(image, 0, 0);
                    analyzeFoodImage(canvas);
                };
                
                image.src = event.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            showError('Please select a valid image file.');
        }
    };
    input.click();
}

// Setup file upload via drag & drop
function setupFileUpload() {
    const preview = document.getElementById('scanPreview');
    
    if (!preview) return;
    
    preview.addEventListener('dragover', (e) => {
        e.preventDefault();
        preview.style.borderColor = 'var(--primary)';
        preview.style.background = '#f0f7ff';
        preview.classList.add('dragover');
    });
    
    preview.addEventListener('dragleave', () => {
        preview.style.borderColor = '#ddd';
        preview.style.background = '#f8f9fa';
        preview.classList.remove('dragover');
    });
    
    preview.addEventListener('drop', (e) => {
        e.preventDefault();
        preview.style.borderColor = '#ddd';
        preview.style.background = '#f8f9fa';
        preview.classList.remove('dragover');
        preview.classList.add('scanning');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    preview.innerHTML = '';
                    
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    preview.appendChild(img);
                    
                    // Convert to canvas for analysis
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const image = new Image();
                    
                    image.onload = () => {
                        canvas.width = image.width;
                        canvas.height = image.height;
                        ctx.drawImage(image, 0, 0);
                        analyzeFoodImage(canvas);
                    };
                    
                    image.src = event.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                showError('Please drop a valid image file.');
                preview.classList.remove('scanning');
            }
        } else {
            preview.classList.remove('scanning');
        }
    });
}

// Simulate food recognition for suggestions
function simulateFoodRecognition(food) {
    const preview = document.getElementById('scanPreview');
    const loading = document.getElementById('scanLoading');
    const results = document.getElementById('scanResults');
    
    preview.innerHTML = '';
    preview.classList.add('scanning');
    
    // Show food icon and name
    const iconContainer = document.createElement('div');
    iconContainer.style.cssText = `
        font-size: 3rem;
        color: var(--primary);
        margin-bottom: 1rem;
        animation: pulse 2s infinite;
    `;
    
    const icon = document.createElement('i');
    icon.className = `fas ${food.icon}`;
    iconContainer.appendChild(icon);
    
    const name = document.createElement('p');
    name.textContent = food.name;
    name.style.cssText = `
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 0.5rem;
    `;
    
    preview.appendChild(iconContainer);
    preview.appendChild(name);
    
    loading.classList.add('active');
    
    // Simulate processing with realistic delay
    setTimeout(() => {
        updateScanResults(food);
        preview.classList.remove('scanning');
        loading.classList.remove('active');
        results.classList.add('active');
        
        // Smooth scroll to results
        setTimeout(() => {
            results.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }, 100);
    }, 1200);
}

// Update scan results with detailed information
function updateScanResults(food) {
    scannedFoodData = food;
    
    // Update basic info
    document.getElementById('scannedFoodName').textContent = food.name;
    document.getElementById('scanConfidence').textContent = `${Math.floor(Math.random() * 10) + 85}% confidence`;
    document.getElementById('scanCalories').textContent = food.calories;
    document.getElementById('scanProtein').textContent = `${food.protein}g`;
    document.getElementById('scanCarbs').textContent = `${food.carbs}g`;
    document.getElementById('scanFat').textContent = `${food.fat}g`;
    
    // Calculate and display additional metrics
    const totalWeight = food.protein + food.carbs + food.fat;
    const proteinPercentage = totalWeight > 0 ? Math.round((food.protein / totalWeight) * 100) : 0;
    const calorieDensity = Math.round(food.calories / 100); // per 100g estimate
    
    // Update nutrition facts
    document.getElementById('nutritionFacts').innerHTML = `
        <div class="nutrition-item">
            <span>Protein %</span>
            <span class="value">${proteinPercentage}%</span>
        </div>
        <div class="nutrition-item">
            <span>Calorie Density</span>
            <span class="value">${calorieDensity} cal/100g</span>
        </div>
        <div class="nutrition-item">
            <span>Food Type</span>
            <span class="value badge ${food.category}">${food.category}</span>
        </div>
    `;
    
    // Show/hide add button based on meal time
    const currentHour = new Date().getHours();
    const addButton = document.getElementById('addScannedFood');
    
    if (currentHour < 6 || currentHour >= 22) {
        addButton.innerHTML = '<i class="fas fa-moon"></i> Add as Late Night Snack';
        addButton.classList.add('late-night');
    } else if (currentHour >= 6 && currentHour < 11) {
        addButton.innerHTML = '<i class="fas fa-sun"></i> Add to Breakfast';
    } else if (currentHour >= 11 && currentHour < 16) {
        addButton.innerHTML = '<i class="fas fa-cloud-sun"></i> Add to Lunch';
    } else {
        addButton.innerHTML = '<i class="fas fa-moon"></i> Add to Dinner';
    }
}

// Add scanned food to log via backend
async function addScannedFoodToLog() {
    if (!scannedFoodData) {
        showError('No food data to add. Please scan a food first.');
        return;
    }
    
    try {
        const currentTime = new Date();
        const timeString = currentTime.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
        });
        
        // Determine meal type based on time
        const currentHour = currentTime.getHours();
        let mealType = 'lunch'; // default
        
        if (currentHour >= 6 && currentHour < 11) mealType = 'breakfast';
        else if (currentHour >= 11 && currentHour < 16) mealType = 'lunch';
        else if (currentHour >= 16 && currentHour < 22) mealType = 'dinner';
        else mealType = 'snack';
        
        // Show loading state
        const addButton = document.getElementById('addScannedFood');
        const originalText = addButton.innerHTML;
        addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        addButton.disabled = true;
        
        // Build local food entry (no backend)
        const dateString = currentTime.toISOString().split('T')[0]; // YYYY-MM-DD
        const newFood = {
            id: Date.now(),
            name: scannedFoodData.name,
            calories: scannedFoodData.calories,
            meal: mealType,
            time: timeString,
            date: dateString,
            scanned: true,
            protein: scannedFoodData.protein,
            carbs: scannedFoodData.carbs,
            fat: scannedFoodData.fat
        };
        
        if (window.foodLog) {
            window.foodLog.push(newFood);
            updateFoodLog();
            calculateTotals();
        }
        
        // Show success message
        showNotification(`${scannedFoodData.name} added to your ${mealType} via Nutri Scan AI!`, 'success');
        
        // Reset scan
        resetScan();
        
        // Reset button state
        addButton.disabled = false;
        addButton.innerHTML = originalText || '<i class="fas fa-plus"></i> Add to Food Log';
        
    } catch (error) {
        console.error('Error adding scanned food:', error);
        showError('Failed to add food to log. Please try again.');
        
        const addButton = document.getElementById('addScannedFood');
        addButton.disabled = false;
        addButton.innerHTML = '<i class="fas fa-plus"></i> Add to Food Log';
    }
}

// Reset scan
function resetScan() {
    document.getElementById('scanResults').classList.remove('active');
    document.getElementById('scanPreview').innerHTML = `
        <i class="fas fa-camera"></i>
        <p>Tap to scan your food</p>
        <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">or select an option above</p>
    `;
    document.getElementById('scanPreview').classList.remove('scanning');
    scannedFoodData = null;
}

// Toggle nutrition info display
function toggleNutritionInfo() {
    const infoSection = document.getElementById('nutritionInfo');
    const toggleButton = document.getElementById('toggleNutritionInfo');
    
    if (infoSection.classList.contains('collapsed')) {
        infoSection.classList.remove('collapsed');
        toggleButton.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Nutrition Info';
    } else {
        infoSection.classList.add('collapsed');
        toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i> Show Nutrition Info';
    }
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
        <span>${message}</span>
        <button class="close-notification">&times;</button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
    
    // Close button
    notification.querySelector('.close-notification').addEventListener('click', () => {
        notification.remove();
    });
}

// Show error message
function showError(message) {
    showNotification(message, 'error');
}

// Add CSS styles for new components
function addNutriScanStyles() {
    const styles = `
        /* NutriScan AI Styles */
        .food-suggestion {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .food-suggestion:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .food-suggestion.scanned {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f8f9fa 0%, #e9f7fe 100%);
        }
        
        .protein-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .camera-guidance {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            max-width: 300px;
            z-index: 1000;
        }
        
        .camera-guidance i {
            color: #ffd700;
            margin-right: 5px;
        }
        
        .camera-guidance ul {
            margin: 5px 0 0 0;
            padding-left: 20px;
        }
        
        .camera-guidance li {
            margin-bottom: 3px;
        }
        
        .scanning {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .dragover {
            border-style: dashed !important;
            border-width: 3px !important;
        }
        
        .nutrition-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .nutrition-item:last-child {
            border-bottom: none;
        }
        
        .nutrition-item .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            background: #e9ecef;
        }
        
        .badge.protein { background: #d4edda; color: #155724; }
        .badge.fruit { background: #fff3cd; color: #856404; }
        .badge.vegetable { background: #d1ecf1; color: #0c5460; }
        .badge.grain { background: #f8d7da; color: #721c24; }
        .badge.dairy { background: #cce5ff; color: #004085; }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        
        .notification.success {
            border-left: 4px solid #28a745;
        }
        
        .notification.error {
            border-left: 4px solid #dc3545;
        }
        
        .notification.info {
            border-left: 4px solid #17a2b8;
        }
        
        .close-notification {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: auto;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .food-suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .food-suggestion.large {
            padding: 15px;
        }
        
        .suggestion-macros {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        #addScannedFood.late-night {
            background: linear-gradient(135deg, #4a4e69 0%, #22223b 100%);
        }
    `;
    
    const styleSheet = document.createElement('style');
    styleSheet.textContent = styles;
    document.head.appendChild(styleSheet);
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    // Add CSS styles first
    addNutriScanStyles();
    
    // Initialize NutriScan AI after a short delay
    setTimeout(() => {
        initNutriScanAI();
    }, 500);
});
        // Add this to the existing JavaScript, after the Nutri Scan AI section

// ========== SYSTEM RECOMMENDATIONS INTEGRATION ==========

// Add recommendation section to dashboard
const dashboardTab = document.getElementById('dashboard');
dashboardTab.innerHTML = `
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Today's Calories</h2>
            <span class="calorie-total">1,850 / 2,000</span>
        </div>
        <div class="progress-container">
            <div class="progress-label">
                <span>Calories Consumed</span>
                <span id="calories-consumed-percent">92%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="calories-consumed-bar" style="width: 92%;"></div>
            </div>
        </div>
        <div class="progress-container">
            <div class="progress-label">
                <span>Calories Burned</span>
                <span id="calories-burned-percent">16%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="calories-burned-bar" style="width: 16%;"></div>
            </div>
        </div>
        <div class="calories-display">
            <div class="calorie-item">
                <div class="calorie-value" id="calories-consumed">1,850</div>
                <div class="calorie-label">Consumed</div>
            </div>
            <div class="calorie-item">
                <div class="calorie-value" id="calories-burned">320</div>
                <div class="calorie-label">Burned</div>
            </div>
            <div class="calorie-item">
                <div class="calorie-value" id="calories-remaining">150</div>
                <div class="calorie-label">Remaining</div>
            </div>
        </div>
        <div class="dashboard-quick">
            <button class="dashboard-quick-btn" data-quick-tab="food">
                <i class="fas fa-utensils"></i>
                <span>Food</span>
            </button>
            <button class="dashboard-quick-btn" data-quick-tab="exercise">
                <i class="fas fa-running"></i>
                <span>Exercise</span>
            </button>
            <button class="dashboard-quick-btn" data-quick-tab="water">
                <i class="fas fa-tint"></i>
                <span>Water</span>
            </button>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">System Recommendations</h2>
            <button class="btn" id="refresh-recommendations" style="padding: 5px 10px; font-size: 0.8rem;">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        <div id="recommendations-container">
            <div style="text-align: center; padding: 20px; color: #666;">
                <i class="fas fa-robot" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                <p>Loading personalized recommendations...</p>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Water Intake</h2>
            <span id="water-total">6.5 / 8 glasses</span>
        </div>
        <div class="progress-container">
            <div class="progress-label">
                <span>Daily Hydration</span>
                <span id="water-progress-percent">81%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="water-progress-bar" style="width: 81%;"></div>
            </div>
        </div>
        <div class="water-container" id="dashboard-water">
            <!-- Water glasses will be dynamically generated here -->
        </div>
    </div>
    
    
        <div class="log-list" id="recent-activities">
            <!-- Recent activities will be dynamically added here -->
        </div>
    </div>
`;

// Add this after the tab switching functionality
const refreshRecommendationsBtn = document.getElementById('refresh-recommendations');
if (refreshRecommendationsBtn) {
    refreshRecommendationsBtn.addEventListener('click', loadRecommendations);
}

// Function to load recommendations
async function loadRecommendations() {
    if (!currentUser) return;
    
    const container = document.getElementById('recommendations-container');
    container.innerHTML = `
        <div style="text-align: center; padding: 20px; color: #666;">
            <div class="loading-spinner" style="margin: 0 auto 15px;"></div>
            <p>Analyzing your progress...</p>
        </div>
    `;
    
    try {
        // Get today's date in YYYY-MM-DD format
        const today = new Date().toISOString().split('T')[0];
        
        // Calculate totals from local data
        const totalFoodCalories = foodLog.reduce((total, item) => total + item.calories, 0);
        const totalExerciseCalories = exerciseLog.reduce((total, item) => total + item.calories, 0);
        const netCalories = totalFoodCalories - totalExerciseCalories;
        
        // Generate recommendations based on user data
        const recommendations = generateLocalRecommendations(
            currentUser.goal,
            currentUser.dailyCalories,
            totalFoodCalories,
            totalExerciseCalories,
            netCalories
        );
        
        // Display recommendations
        displayRecommendations(recommendations, totalFoodCalories, totalExerciseCalories);
        
    } catch (error) {
        console.error('Error loading recommendations:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #e76f51;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>Unable to load recommendations. Please try again.</p>
            </div>
        `;
    }
}

// Local recommendation generation
function generateLocalRecommendations(goal, targetCalories, consumed, burned, netCalories) {
    const recommendations = {
        message: "",
        food_suggestions: [],
        activity_suggestions: [],
        status: "",
        remaining_calories: 0
    };
    
    // Calculate remaining calories based on goal
    let remaining = 0;
    
    if (goal === "weight_loss") {
        remaining = (targetCalories - 300) - netCalories;
        recommendations.status = netCalories > targetCalories - 300 ? "warning" : "success";
        recommendations.message = netCalories > targetCalories - 300 
            ? "You're above your weight loss calorie target." 
            : "Great! You're on track for weight loss.";
    } 
    else if (goal === "muscle_gain") {
        remaining = (targetCalories + 300) - netCalories;
        recommendations.status = netCalories < targetCalories + 300 ? "warning" : "success";
        recommendations.message = netCalories < targetCalories + 300
            ? "You need more calories for muscle gain."
            : "Perfect! You're getting enough calories for muscle growth.";
    } 
    else { // maintenance
        remaining = targetCalories - netCalories;
        recommendations.status = Math.abs(remaining) > 200 ? "warning" : "success";
        recommendations.message = Math.abs(remaining) > 200
            ? "Adjust your intake to maintain your weight:"
            : "You're maintaining your weight well!";
    }
    
    recommendations.remaining_calories = remaining;
    
    // Food recommendations
    if (remaining > 0) {
        if (goal === "muscle_gain") {
            recommendations.food_suggestions = [
                { name: "Protein Shake", calories: 150, protein: 30 },
                { name: "Grilled Chicken", calories: 165, protein: 31 },
                { name: "Brown Rice", calories: 112, protein: 2.6 },
                { name: "Eggs (3 whole)", calories: 215, protein: 19 },
                { name: "Greek Yogurt", calories: 100, protein: 18 }
            ];
        } else {
            recommendations.food_suggestions = [
                { name: "Grilled Salmon", calories: 206, protein: 22 },
                { name: "Quinoa Salad", calories: 120, protein: 4 },
                { name: "Vegetable Stir-fry", calories: 150, protein: 5 },
                { name: "Apple with Almond Butter", calories: 200, protein: 5 },
                { name: "Mixed Greens Salad", calories: 80, protein: 3 }
            ];
        }
    } else if (remaining < 0) {
        recommendations.food_suggestions = [
            { name: "Choose lighter meal options", calories: 150, protein: 10 },
            { name: "Increase vegetable portions", calories: 50, protein: 2 },
            { name: "Lean protein sources", calories: 120, protein: 20 },
            { name: "Drink water before meals", calories: 0, protein: 0 },
            { name: "Smaller, frequent meals", calories: 100, protein: 8 }
        ];
    }
    
    // Activity recommendations
    if (goal === "weight_loss") {
        recommendations.activity_suggestions = [
            { activity: "30 min HIIT workout", calories_burned: 350, duration: 30 },
            { activity: "45 min brisk walking", calories_burned: 225, duration: 45 },
            { activity: "Cycling (moderate)", calories_burned: 275, duration: 30 },
            { activity: "Swimming laps", calories_burned: 300, duration: 30 }
        ];
    } else if (goal === "muscle_gain") {
        recommendations.activity_suggestions = [
            { activity: "Strength training", calories_burned: 250, duration: 60 },
            { activity: "Compound exercises", calories_burned: 200, duration: 45 },
            { activity: "Resistance band workout", calories_burned: 180, duration: 30 },
            { activity: "Light cardio", calories_burned: 150, duration: 20 }
        ];
    } else {
        recommendations.activity_suggestions = [
            { activity: "30 min jogging", calories_burned: 275, duration: 30 },
            { activity: "Yoga/Pilates", calories_burned: 175, duration: 45 },
            { activity: "Bodyweight circuit", calories_burned: 200, duration: 20 },
            { activity: "Dancing", calories_burned: 225, duration: 30 }
        ];
    }
    
    return recommendations;
}

// Display recommendations
function displayRecommendations(recommendations, consumed, burned) {
    const container = document.getElementById('recommendations-container');
    
    // Determine status icon and color
    let statusIcon = "fa-check-circle";
    let statusColor = "#2a9d8f"; // success color
    let statusText = "On Track";
    
    if (recommendations.status === "warning") {
        statusIcon = "fa-exclamation-triangle";
        statusColor = "#e9c46a"; // warning color
        statusText = "Needs Adjustment";
    }
    
    container.innerHTML = `
        <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <i class="fas ${statusIcon}" style="color: ${statusColor}; font-size: 1.5rem;"></i>
                <div>
                    <h3 style="margin: 0; color: ${statusColor};">${statusText}</h3>
                    <p style="margin: 5px 0 0 0; color: #666;">${recommendations.message}</p>
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--danger);">${consumed}</div>
                        <div style="font-size: 0.8rem; color: #666;">Calories In</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--success);">${burned}</div>
                        <div style="font-size: 0.8rem; color: #666;">Calories Out</div>
                    </div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary);">
                        ${Math.abs(recommendations.remaining_calories)} calories 
                        ${recommendations.remaining_calories > 0 ? 'remaining' : 'over'}
                    </div>
                </div>
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; font-size: 1.1rem; color: var(--secondary);">Food Suggestions</h3>
            <span style="font-size: 0.8rem; color: #666;">Based on your goal</span>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 25px;">
            ${recommendations.food_suggestions.map(food => `
                <div class="food-suggestion-item" 
                     style="background: white; border: 1px solid #eaeaea; border-radius: 8px; padding: 10px; cursor: pointer; transition: all 0.3s;"
                     onclick="quickAddFood('${food.name}', ${food.calories})">
                    <div style="font-weight: 600; margin-bottom: 5px; font-size: 0.9rem;">${food.name}</div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                        <span style="color: #666;">${food.calories} cal</span>
                        ${food.protein > 0 ? `<span style="color: var(--primary);">${food.protein}g protein</span>` : ''}
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; font-size: 1.1rem; color: var(--secondary);">Activity Suggestions</h3>
            <span style="font-size: 0.8rem; color: #666;">To reach your goal</span>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
            ${recommendations.activity_suggestions.map(activity => `
                <div class="activity-suggestion-item" 
                     style="background: white; border: 1px solid #eaeaea; border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s;"
                     onclick="quickAddExercise('${activity.activity}', ${activity.calories_burned}, ${activity.duration})">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <div style="font-weight: 600; font-size: 0.95rem;">${activity.activity}</div>
                        <span style="color: var(--danger); font-weight: 600; font-size: 0.9rem;">-${activity.calories_burned} cal</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #666;">
                        <span>${activity.duration} minutes</span>
                        <span>Click to add</span>
                    </div>
                </div>
            `).join('')}
        </div>
        
        
    `;
    
    // Add hover effects
    const foodItems = container.querySelectorAll('.food-suggestion-item');
    const activityItems = container.querySelectorAll('.activity-suggestion-item');
    
    foodItems.forEach(item => {
        item.addEventListener('mouseenter', () => {
            item.style.transform = 'translateY(-3px)';
            item.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
            item.style.borderColor = 'var(--primary)';
        });
        item.addEventListener('mouseleave', () => {
            item.style.transform = 'translateY(0)';
            item.style.boxShadow = 'none';
            item.style.borderColor = '#eaeaea';
        });
    });
    
    activityItems.forEach(item => {
        item.addEventListener('mouseenter', () => {
            item.style.transform = 'translateY(-3px)';
            item.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
            item.style.borderColor = 'var(--primary)';
        });
        item.addEventListener('mouseleave', () => {
            item.style.transform = 'translateY(0)';
            item.style.boxShadow = 'none';
            item.style.borderColor = '#eaeaea';
        });
    });
}

// Quick add food from suggestion
function quickAddFood(name, calories) {
    const currentTime = new Date();
    const timeString = currentTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    const dateString = currentTime.toISOString().split('T')[0]; // YYYY-MM-DD
    
    const newFood = {
        id: Date.now(),
        name,
        calories,
        meal: getCurrentMeal(),
        time: timeString,
        date: dateString, // Add date tracking
        scanned: false
    };
    
    foodLog.push(newFood);
    updateFoodLog();
    calculateTotals();
    
    // Switch to food tab to show the added item
    tabs.forEach(t => t.classList.remove('active'));
    document.querySelector('.tab[data-tab="food"]').classList.add('active');
    
    tabContents.forEach(content => content.classList.remove('active'));
    document.getElementById('food').classList.add('active');
    
    alert(`${name} added to your food log!`);
    
    // Refresh recommendations after adding
    setTimeout(loadRecommendations, 500);
}

// Quick add exercise from suggestion
function quickAddExercise(name, calories, duration) {
    const currentTime = new Date();
    const timeString = currentTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    
    const newExercise = {
        id: Date.now(),
        name,
        duration,
        calories,
        time: timeString
    };
    
    exerciseLog.push(newExercise);
    updateExerciseLog();
    calculateTotals();
    
    // Switch to exercise tab to show the added item
    tabs.forEach(t => t.classList.remove('active'));
    document.querySelector('.tab[data-tab="exercise"]').classList.add('active');
    
    tabContents.forEach(content => content.classList.remove('active'));
    document.getElementById('exercise').classList.add('active');
    
    alert(`${name} added to your exercise log!`);
    
    // Refresh recommendations after adding
    setTimeout(loadRecommendations, 500);
}

// Get current meal based on time
function getCurrentMeal() {
    const hour = new Date().getHours();
    if (hour < 11) return 'breakfast';
    if (hour < 15) return 'lunch';
    if (hour < 18) return 'snack';
    return 'dinner';
}

// Local recommendation generation with easy Filipino food and exercise activities
function generateLocalRecommendations(goal, targetCalories, consumed, burned, netCalories) {
    const recommendations = {
        message: "",
        daily_meals: [], // Will contain 3 meals: breakfast, lunch, dinner
        activity_suggestions: [],
        status: "",
        remaining_calories: 0
    };
    
    // Calculate remaining calories based on goal
    let remaining = 0;
    
    if (goal === "weight_loss") {
        remaining = (targetCalories - 300) - netCalories;
        recommendations.status = netCalories > targetCalories - 300 ? "warning" : "success";
        recommendations.message = netCalories > targetCalories - 300 
            ? "You're above your weight loss calorie target." 
            : "Great! You're on track for weight loss.";
    } 
    else if (goal === "muscle_gain") {
        remaining = (targetCalories + 300) - netCalories;
        recommendations.status = netCalories < targetCalories + 300 ? "warning" : "success";
        recommendations.message = netCalories < targetCalories + 300
            ? "You need more calories for muscle gain."
            : "Perfect! You're getting enough calories for muscle growth.";
    } 
    else { // maintenance
        remaining = targetCalories - netCalories;
        recommendations.status = Math.abs(remaining) > 200 ? "warning" : "success";
        recommendations.message = Math.abs(remaining) > 200
            ? "Adjust your intake to maintain your weight."
            : "You're maintaining your weight well!";
    }
    
    recommendations.remaining_calories = remaining;
    
    // EASY FILIPINO FOODS - Simple to prepare
    const easyFilipinoFoods = {
        breakfast: [
            { name: "Boiled Eggs with Rice", calories: 280, protein: 14, carbs: 35, prep: "5 min", description: "Simple boiled eggs with rice" },
            { name: "Pandesal with Cheese", calories: 220, protein: 10, carbs: 30, prep: "2 min", description: "Ready-to-eat bread roll with cheese" },
            { name: "Oatmeal with Banana", calories: 200, protein: 6, carbs: 40, prep: "5 min", description: "Just add hot water and banana" },
            { name: "Cereal with Milk", calories: 180, protein: 8, carbs: 30, prep: "1 min", description: "Quick cereal breakfast" },
            { name: "Fruit Salad", calories: 150, protein: 2, carbs: 35, prep: "10 min", description: "Fresh fruits mixed together" }
        ],
        lunch: [
            { name: "Fried Rice with Egg", calories: 320, protein: 12, carbs: 45, prep: "10 min", description: "Leftover rice with fried egg" },
            { name: "Sandwich with Ham", calories: 280, protein: 15, carbs: 30, prep: "5 min", description: "Simple sandwich with ham" },
            { name: "Instant Noodles with Egg", calories: 300, protein: 10, carbs: 40, prep: "5 min", description: "Quick noodles with egg" },
            { name: "Canned Tuna with Rice", calories: 250, protein: 18, carbs: 25, prep: "2 min", description: "Canned tuna with rice" },
            { name: "Salad with Chicken", calories: 220, protein: 20, carbs: 10, prep: "10 min", description: "Pre-cooked chicken with greens" }
        ],
        dinner: [
            { name: "Chicken Soup (Tinola)", calories: 200, protein: 18, carbs: 12, prep: "20 min", description: "Simple chicken and vegetable soup" },
            { name: "Fried Fish with Rice", calories: 280, protein: 22, carbs: 30, prep: "15 min", description: "Pan-fried fish fillet" },
            { name: "Stir-fried Vegetables", calories: 180, protein: 6, carbs: 20, prep: "10 min", description: "Mixed vegetables quickly stir-fried" },
            { name: "Scrambled Eggs with Toast", calories: 240, protein: 14, carbs: 25, prep: "8 min", description: "Quick egg dinner" },
          
        ]
    };
    
    // EXERCISE ACTIVITIES (No everyday activities)
    const exerciseActivities = [
        // Cardio exercises
        { activity: "Brisk Walking", calories_burned: 180, duration: 30, intensity: "Light", type: "Cardio", description: "Fast-paced walking in park or treadmill" },
        { activity: "Jogging", calories_burned: 280, duration: 30, intensity: "Moderate", type: "Cardio", description: "Light running at comfortable pace" },
        { activity: "Cycling", calories_burned: 240, duration: 30, intensity: "Moderate", type: "Cardio", description: "Stationary or outdoor cycling" },
        { activity: "Jump Rope", calories_burned: 300, duration: 15, intensity: "High", type: "Cardio", description: "Skipping rope for cardio" },
        { activity: "Swimming", calories_burned: 250, duration: 30, intensity: "Moderate", type: "Cardio", description: "Freestyle swimming laps" },
        
        // Strength exercises
        { activity: "Push-ups", calories_burned: 100, duration: 10, intensity: "Moderate", type: "Strength", description: "Bodyweight chest exercise" },
        { activity: "Squats", calories_burned: 120, duration: 10, intensity: "Moderate", type: "Strength", description: "Bodyweight leg exercise" },
        { activity: "Plank", calories_burned: 80, duration: 5, intensity: "Moderate", type: "Strength", description: "Core strength exercise" },
        { activity: "Lunges", calories_burned: 110, duration: 10, intensity: "Moderate", type: "Strength", description: "Leg strengthening exercise" },
        { activity: "Sit-ups", calories_burned: 90, duration: 10, intensity: "Light", type: "Strength", description: "Abdominal exercise" },
        
        // Mixed workouts
        { activity: "Bodyweight Circuit", calories_burned: 220, duration: 20, intensity: "High", type: "Mixed", description: "Push-ups, squats, planks circuit" },
        { activity: "Yoga", calories_burned: 150, duration: 30, intensity: "Light", type: "Mixed", description: "Hatha or Vinyasa yoga session" },
        { activity: "Pilates", calories_burned: 160, duration: 30, intensity: "Light", type: "Mixed", description: "Core-focused Pilates workout" },
        { activity: "Dance Workout", calories_burned: 200, duration: 30, intensity: "Moderate", type: "Mixed", description: "Fun dance-based exercise" },
        { activity: "Stair Climbing", calories_burned: 250, duration: 15, intensity: "High", type: "Cardio", description: "Climbing stairs for cardio" }
    ];
    
    // Use login timestamp seed for different recommendations on each login
    // Get or create login seed from localStorage (changes on each login)
    const loginSeedKey = `loginSeed_${currentUser.id}`;
    let loginSeed = localStorage.getItem(loginSeedKey);
    
    if (!loginSeed) {
        // First login or seed expired - create new seed based on current timestamp
        loginSeed = Date.now().toString();
        localStorage.setItem(loginSeedKey, loginSeed);
    } else {
        // Update seed on each login to get different recommendations
        loginSeed = Date.now().toString();
        localStorage.setItem(loginSeedKey, loginSeed);
    }
    
    // Convert seed to number and use for selection
    const seedNum = parseInt(loginSeed.slice(-8)) || parseInt(loginSeed); // Use last 8 digits
    const mealIndex = seedNum % 5; // Cycle through 5 different meal plans
    
    // Select 3 meals (breakfast, lunch, dinner) based on day rotation
    recommendations.daily_meals = [
        {
            meal: "Breakfast",
            food: easyFilipinoFoods.breakfast[mealIndex] || easyFilipinoFoods.breakfast[0],
            time: "7:00-9:00 AM",
            icon: "fa-mug-hot"
        },
        {
            meal: "Lunch",
            food: easyFilipinoFoods.lunch[mealIndex] || easyFilipinoFoods.lunch[0],
            time: "12:00-2:00 PM",
            icon: "fa-utensils"
        },
        {
            meal: "Dinner",
            food: easyFilipinoFoods.dinner[mealIndex] || easyFilipinoFoods.dinner[0],
            time: "6:00-8:00 PM",
            icon: "fa-moon"
        }
    ];
    
    // Select 3 exercise activities based on login seed (different each login)
    recommendations.activity_suggestions = [
        exerciseActivities[seedNum % exerciseActivities.length],
        exerciseActivities[(seedNum + 7) % exerciseActivities.length],
        exerciseActivities[(seedNum + 13) % exerciseActivities.length]
    ];
    
    return recommendations;
}

// Update the displayRecommendations function
function displayRecommendations(recommendations, consumed, burned) {
    const container = document.getElementById('recommendations-container');
    
    // Determine status icon and color
    let statusIcon = "fa-check-circle";
    let statusColor = "#2a9d8f";
    let statusText = "On Track";
    
    if (recommendations.status === "warning") {
        statusIcon = "fa-exclamation-triangle";
        statusColor = "#e9c46a";
        statusText = "Needs Adjustment";
    }
    
    // Get user's goal for display
    const goalDisplay = currentUser ? 
        currentUser.goal.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 
        "Your Goal";
    
    // Get today's date for display
    const today = new Date();
    const dateString = today.toLocaleDateString('en-US', { 
        weekday: 'long', 
        month: 'short', 
        day: 'numeric' 
    });
    
    container.innerHTML = `
        <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <i class="fas ${statusIcon}" style="color: ${statusColor}; font-size: 1.5rem;"></i>
                <div>
                    <h3 style="margin: 0; color: ${statusColor};">${statusText}</h3>
                    <p style="margin: 5px 0 0 0; color: #666;">${recommendations.message}</p>
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="text-align: center; margin-bottom: 10px; color: var(--secondary); font-weight: 600;">
                    <i class="fas fa-calendar-day"></i> ${dateString}  ${goalDisplay}
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--danger);">${consumed}</div>
                        <div style="font-size: 0.8rem; color: #666;">Calories In</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--success);">${burned}</div>
                        <div style="font-size: 0.8rem; color: #666;">Calories Out</div>
                    </div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary);">
                        ${Math.abs(recommendations.remaining_calories)} calories 
                        ${recommendations.remaining_calories > 0 ? 'remaining' : 'over'}
                    </div>
                </div>
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 1.1rem; color: var(--secondary);">
                    <i class="fas fa-utensils"></i> Easy Filipino Meals
                </h3>
                <span style="font-size: 0.8rem; color: #666;">Simple to prepare</span>
            </div>
            <p style="margin: 0 0 15px 0; color: #666; font-size: 0.85rem;">
                Quick and easy Filipino-inspired meals for your day
            </p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 25px;">
            ${recommendations.daily_meals.map(meal => `
                <div class="meal-suggestion-item" 
                     style="background: white; border: 1px solid #eaeaea; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s;"
                     onclick="quickAddFood('${meal.food.name}', ${meal.food.calories})">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="width: 40px; height: 40px; background: ${getMealColor(meal.meal)}; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas ${meal.icon}" style="color: white; font-size: 1rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-weight: 700; color: var(--secondary); font-size: 1rem;">${meal.meal}</div>
                                <span style="font-size: 0.75rem; color: #666; background: #f0f0f0; padding: 2px 8px; border-radius: 12px;">${meal.time}</span>
                            </div>
                            <div style="font-weight: 600; color: var(--primary); font-size: 0.95rem; margin-top: 4px;">${meal.food.name}</div>
                        </div>
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-bottom: 12px; line-height: 1.4;">${meal.food.description}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">
                        <div style="display: flex; gap: 15px;">
                            <span style="color: var(--danger); font-weight: 600;">${meal.food.calories} cal</span>
                            <span style="color: var(--primary);">${meal.food.protein}g protein</span>
                            <span style="color: #666;">${meal.food.carbs}g carbs</span>
                        </div>
                        <span style="color: #10ac84; font-weight: 600; background: #e8f8f3; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">
                            <i class="far fa-clock"></i> ${meal.food.prep}
                        </span>
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 1.1rem; color: var(--secondary);">
                    <i class="fas fa-dumbbell"></i> Exercise Suggestions
                </h3>
                <span style="font-size: 0.8rem; color: #666;">Workout routines</span>
            </div>
            <p style="margin: 0 0 15px 0; color: #666; font-size: 0.85rem;">
                Exercise activities to help reach your fitness goals
            </p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 10px;">
            ${recommendations.activity_suggestions.map(activity => `
                <div class="activity-suggestion-item" 
                     style="background: white; border: 1px solid #eaeaea; border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s;"
                     onclick="quickAddExercise('${activity.activity}', ${activity.calories_burned}, ${activity.duration})">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-weight: 600; font-size: 0.95rem;">${activity.activity}</span>
                                <span style="background: ${getExerciseTypeColor(activity.type)}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem;">
                                    ${activity.type}
                                </span>
                            </div>
                            <div style="font-size: 0.75rem; color: #666;">${activity.description}</div>
                        </div>
                        <span style="color: var(--danger); font-weight: 600; font-size: 0.9rem; margin-left: 10px; white-space: nowrap;">-${activity.calories_burned} cal</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #666; margin-top: 8px;">
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <span><i class="far fa-clock"></i> ${activity.duration} min</span>
                            <span style="background: ${getActivityColor(activity.intensity)}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem;">
                                ${activity.intensity}
                            </span>
                        </div>
                        <span style="color: var(--primary); font-weight: 600;">Click to log</span>
                    </div>
                </div>
            `).join('')}
        </div>
        
       
    `;
    
    // Add hover effects
    const mealItems = container.querySelectorAll('.meal-suggestion-item');
    const activityItems = container.querySelectorAll('.activity-suggestion-item');
    
    mealItems.forEach(item => {
        item.addEventListener('mouseenter', () => {
            item.style.transform = 'translateY(-3px)';
            item.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            item.style.borderColor = 'var(--primary)';
        });
        item.addEventListener('mouseleave', () => {
            item.style.transform = 'translateY(0)';
            item.style.boxShadow = 'none';
            item.style.borderColor = '#eaeaea';
        });
    });
    
    activityItems.forEach(item => {
        item.addEventListener('mouseenter', () => {
            item.style.transform = 'translateY(-3px)';
            item.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
            item.style.borderColor = 'var(--primary)';
        });
        item.addEventListener('mouseleave', () => {
            item.style.transform = 'translateY(0)';
            item.style.boxShadow = 'none';
            item.style.borderColor = '#eaeaea';
        });
    });
}

// Helper function to get color based on meal type
function getMealColor(meal) {
    switch(meal.toLowerCase()) {
        case 'breakfast': return '#ff9f43'; // Orange
        case 'lunch': return '#2e86de'; // Blue
        case 'dinner': return '#5f27cd'; // Purple
        default: return '#10ac84'; // Green
    }
}

// Helper function to get color based on activity intensity
function getActivityColor(intensity) {
    switch(intensity.toLowerCase()) {
        case 'light': return '#00b894'; // Green
        case 'moderate': return '#0984e3'; // Blue
        case 'high': return '#e17055'; // Orange/Red
        default: return '#636e72'; // Gray
    }
}

// Helper function to get color based on exercise type
function getExerciseTypeColor(type) {
    switch(type.toLowerCase()) {
        case 'cardio': return '#e17055'; // Orange/Red
        case 'strength': return '#0984e3'; // Blue
        case 'mixed': return '#00b894'; // Green
        default: return '#636e72'; // Gray
    }
}

// Quick add exercise function
function quickAddExercise(name, calories, duration) {
    const currentTime = new Date();
    const timeString = currentTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    const dateString = currentTime.toISOString().split('T')[0]; // YYYY-MM-DD
    
    const newExercise = {
        id: Date.now(),
        name,
        duration,
        calories,
        time: timeString,
        date: dateString // Add date tracking
    };
    
    exerciseLog.push(newExercise);
    updateExerciseLog();
    calculateTotals();
    
    // Switch to exercise tab to show the added item
    tabs.forEach(t => t.classList.remove('active'));
    document.querySelector('.tab[data-tab="exercise"]').classList.add('active');
    
    tabContents.forEach(content => content.classList.remove('active'));
    document.getElementById('exercise').classList.add('active');
    
    alert(`Added ${name} to your exercise log!`);
    
    // Refresh recommendations after adding
    setTimeout(loadRecommendations, 500);
}
        
        // Override totals calculation to also update hydration progress bar and day streak
        function calculateTotals() {
            // Food calories
            const totalFoodCalories = foodLog.reduce((total, item) => total + item.calories, 0);
            
            // Exercise calories
            const totalExerciseCalories = exerciseLog.reduce((total, item) => total + item.calories, 0);
            
            // Water intake:
            // each waterLog item currently uses amount = 0.5 (for one 250ml glass),
            // so convert summed amount into whole glasses for display & percentages.
            const totalWaterUnits = waterLog.reduce((total, item) => total + item.amount, 0);
            
            // Determine calorie target based on goal
            let calorieTarget = currentUser.dailyCalories;
            if (currentUser.goal === 'weight_loss') {
                calorieTarget = Math.max(1200, currentUser.dailyCalories - 300);
            } else if (currentUser.goal === 'muscle_gain') {
                calorieTarget = currentUser.dailyCalories + 300;
            }

            // Update dashboard calorie numbers
            document.getElementById('calories-consumed').textContent = totalFoodCalories;
            document.getElementById('calories-burned').textContent = totalExerciseCalories;
            
            const remaining = calorieTarget - totalFoodCalories + totalExerciseCalories;
            document.getElementById('calories-remaining').textContent = Math.max(0, remaining);
            
            // Percent of calorie goal consumed (based on goal-adjusted target)
            const consumedPercentage = Math.min(100, (totalFoodCalories / calorieTarget) * 100);
            
            // Water goal in glasses
            const waterGoal = Math.max(8, Math.round(currentUser.weight / 10));
            const totalWaterGlasses = totalWaterUnits / 0.5; // 1 glass per 0.5 unit
            document.getElementById('water-total').textContent = `${totalWaterGlasses} / ${waterGoal} glasses`;
            const waterPercentage = Math.min(100, (totalWaterGlasses / waterGoal) * 100);

            // Update day streak (counts any day with activity as active)
            const today = new Date().toISOString().split('T')[0];
            if (lastActiveDate !== today) {
                const lastDateObj = lastActiveDate ? new Date(lastActiveDate) : null;
                const diffDays = lastDateObj
                    ? Math.round((new Date(today) - lastDateObj) / (1000 * 60 * 60 * 24))
                    : 0;

                if (diffDays === 1) {
                    // Consecutive day -> increment streak
                    streakDays += 1;
                } else if (diffDays > 1) {
                    // Gap in days -> reset streak
                    streakDays = 1;
                }

                lastActiveDate = today;

                // Reflect updated streak in header
                updateProfileHeader();
            }
            
            // Update dashboard progress bars (calories consumed, calories burned, hydration)
            const dashboard = document.getElementById('dashboard');
            if (dashboard) {
                // Calories consumed progress bar
                const consumedBar = document.getElementById('calories-consumed-bar');
                const consumedPercentLabel = document.getElementById('calories-consumed-percent');
                if (consumedBar) {
                    consumedBar.style.width = `${consumedPercentage}%`;
                }
                if (consumedPercentLabel) {
                    consumedPercentLabel.textContent = `${Math.round(consumedPercentage)}%`;
                }

                // Calories burned progress bar (relative to goal-adjusted calorie target / 2)
                const burnedBar = document.getElementById('calories-burned-bar');
                const burnedPercentLabel = document.getElementById('calories-burned-percent');
                const burnTarget = Math.max(100, calorieTarget / 2); // simple target: half of target calories
                const burnedPercentage = Math.min(100, (totalExerciseCalories / burnTarget) * 100);
                if (burnedBar) {
                    burnedBar.style.width = `${burnedPercentage}%`;
                }
                if (burnedPercentLabel) {
                    burnedPercentLabel.textContent = `${Math.round(burnedPercentage)}%`;
                }

                // Hydration progress bar
                const waterBar = document.getElementById('water-progress-bar');
                const waterPercentLabel = document.getElementById('water-progress-percent');
                if (waterBar) {
                    waterBar.style.width = `${waterPercentage}%`;
                }
                if (waterPercentLabel) {
                    waterPercentLabel.textContent = `${Math.round(waterPercentage)}%`;
                }
                
                const calorieTotalEl = dashboard.querySelector('.calorie-total');
                if (calorieTotalEl) {
                    calorieTotalEl.textContent = `${totalFoodCalories} / ${calorieTarget.toLocaleString()}`;
                }
            }
            
            // Update visual water glasses (uses raw units and goal)
            updateDashboardWater(totalWaterUnits, waterGoal);
            
            // Update summary
            document.getElementById('total-calories').textContent = totalFoodCalories;
            document.getElementById('total-burned').textContent = totalExerciseCalories;
            document.getElementById('net-calories').textContent = totalFoodCalories - totalExerciseCalories;
            document.getElementById('total-water').textContent = totalWaterGlasses;
            
            // Update recent activities
            updateRecentActivities();

            // Refresh System Recommendations so "Calories In/Out" stays in sync
            // (debounced to avoid excessive re-rendering when multiple updates happen quickly)
            if (typeof loadRecommendations === 'function') {
                if (recommendationsRefreshTimer) {
                    clearTimeout(recommendationsRefreshTimer);
                }
                recommendationsRefreshTimer = setTimeout(() => {
                    const container = document.getElementById('recommendations-container');
                    if (container) {
                        loadRecommendations();
                    }
                }, 200);
            }
            
            // Persist data
            saveUserData();
        }
        
        // Initialize the app
        function initApp() {
            updateFoodLog();
            updateExerciseLog();
            initWaterTracker();
            calculateTotals();
            initNutriScanAI(); // Initialize Nutri Scan AI
            
            // Load recommendations on login (will be different each time)
            if (typeof loadRecommendations === 'function') {
                setTimeout(() => loadRecommendations(), 500);
            }
        }
        
        // Check if user is already logged in
        function checkLoggedIn() {
            const loggedInUserId = localStorage.getItem('fitTrackLoggedIn');
            if (loggedInUserId) {
                const user = users.find(u => u.id === parseInt(loggedInUserId));
                if (user) {
                    currentUser = user;
                    loadUserData();
                    showMainApp();
                }
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', checkLoggedIn);
    </script>
</body>
</html>